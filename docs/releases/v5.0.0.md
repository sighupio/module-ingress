# Ingress Module Release v5.0.0

Welcome to the latest release of `Ingress` module of [`SIGHUP Distribution`](https://github.com/sighupio/fury-distribution) maintained by team SIGHUP.

This release updates several packages included in the ingress module, to officially support Kubernetes v1.34. 

## Component versions ðŸš¢

| Component          | Supported Version                                                                        | Previous Version |
| ------------------ | ---------------------------------------------------------------------------------------- | :--------------: |
| `aws-cert-manager` | N.A.                                                                                     |   `No update`    |
| `aws-external-dns` | N.A.                                                                                     |   `No update`    |
| `cert-manager`     | [`v1.19.2`](https://cert-manager.io/docs/releases/release-notes/release-notes-1.19/)     |    `v1.18.2`     |
| `dual-nginx`       | [`v1.14.3`](https://github.com/kubernetes/ingress-nginx/releases/tag/controller-v1.14.3) |    `v1.13.3`     |
| `external-dns`     | [`v0.20.0`](https://github.com/kubernetes-sigs/external-dns/releases/tag/v0.20.0)        |    `v0.18.0`     |
| `forecastle`       | [`v1.0.159`](https://github.com/stakater/Forecastle/releases/tag/v1.0.159)               |    `v1.0.157`    |
| `haproxy`          | [`v3.2.4`](https://github.com/haproxytech/kubernetes-ingress/releases/tag/v3.2.4)        |      `New`       |
| `dual-haproxy`     | [`v3.2.4`](https://github.com/haproxytech/kubernetes-ingress/releases/tag/v3.2.4)        |      `New`       |
| `nginx`            | [`v1.14.3`](https://github.com/kubernetes/ingress-nginx/releases/tag/controller-v1.14.3) |    `v1.13.3`     |

> Please refer the individual release notes to get a more detailed information on each release.

## New features ðŸŽ‰

### HAProxy Ingress Controller v3.2.4

Added HAProxy Ingress Controller as a new ingress option, supporting both single and dual deployment modes.

Features include:
- Single and dual (internal/external) deployment configurations
- Grafana dashboard (ID 12693) for HAProxy metrics
- PrometheusRule for alerting
- TLS default certificate support
- IngressClass configuration (`haproxy`, `haproxy-internal`, `haproxy-external`)

For detailed information about HAProxy Ingress Controller, please refer to the [upstream documentation](https://www.haproxy.com/documentation/kubernetes-ingress/).

## Breaking changes ðŸ’”

âš ï¸ **WARNING**

### NGINX and HAProxy Log Format Changes

The log formats for both NGINX and HAProxy ingress controllers have been updated to include the Host header:

- **NGINX**: Log format now includes `$host` field
- **HAProxy**: Log format now includes Host header capture

This change requires module-logging v6.0.0 or later to parse logs correctly. Both modules must be upgraded together.

### Forecastle namespace migration

Forecastle has been moved from the `ingress-nginx` namespace to its own dedicated `forecastle` namespace. Existing deployments will need to manually delete the old resources from `ingress-nginx` before applying the new manifests. See the Upgrade Guide for detailed migration steps.

### External-DNS namespace migration

External-DNS has been moved from the `ingress-nginx` namespace to its own dedicated `external-dns` namespace. Both public and private variants now deploy to the same `external-dns` namespace. See the Upgrade Guide for detailed migration steps.

## Kubernetes support ðŸš¢

| Kubernetes Version |   Compatibility    | Notes           |
| ------------------ | :----------------: | --------------- |
| `1.31.x`           | :white_check_mark: | No known issues |
| `1.32.x`           | :white_check_mark: | No known issues |
| `1.33.x`           | :white_check_mark: | No known issues |
| `1.34.x`           | :white_check_mark: | No known issues |

## Upgrade Guide ðŸ¦®

> â„¹ï¸ **INFO**
>
> This update guide is for users of the module and not of the Distribution or users still on furyctl legacy.
> If you are a SD user, the update is performed automatically by furyctl.

### Process

To upgrade this core module from `v4.1.1` to `v5.0.0`, you need to download this new version and apply the following process.

### Forecastle migration

Forecastle has been moved from the `ingress-nginx` namespace to its own dedicated `forecastle` namespace.

To migrate the existing deployment:

1. Delete the old Forecastle resources from the `ingress-nginx` namespace:

```bash
kubectl delete deployment forecastle -n ingress-nginx
kubectl delete service forecastle -n ingress-nginx
kubectl delete serviceaccount forecastle -n ingress-nginx
kubectl delete configmap -n ingress-nginx $(kubectl get configmap -n ingress-nginx -o name 2>/dev/null | grep forecastle) 2>/dev/null || true
```

2. Apply the new manifests:

```bash
kustomize build <your-project-path> | kubectl apply -f - --server-side
```

3. Verify the new deployment is running:

```bash
kubectl get pods -n forecastle
```

> **Note:** The ClusterRole and ClusterRoleBinding are cluster-scoped resources and will be updated in place.

### External-DNS migration

External-DNS has been moved from the `ingress-nginx` namespace to its own dedicated `external-dns` namespace.

#### AWS users

If you are using the `aws-external-dns` Terraform module, you must update and apply Terraform before deploying the new Kubernetes manifests. The IAM OIDC trust policy has been updated to reference the new namespace.

1. Update the Terraform module to the new version

2. Apply Terraform changes:

```bash
terraform apply
```

3. Delete the old External-DNS resources from the `ingress-nginx` namespace:

```bash
# For external-dns-public
kubectl delete deployment external-dns-public -n ingress-nginx
kubectl delete service external-dns-metrics-public -n ingress-nginx
kubectl delete serviceaccount external-dns-public -n ingress-nginx

# For external-dns-private
kubectl delete deployment external-dns-private -n ingress-nginx
kubectl delete service external-dns-metrics-private -n ingress-nginx
kubectl delete serviceaccount external-dns-private -n ingress-nginx
```

4. Apply the new manifests:

```bash
kustomize build <your-project-path> | kubectl apply -f - --server-side
```

5. Verify the new deployment is running:

```bash
kubectl get pods -n external-dns
```

#### Other users

1. Delete the old External-DNS resources from the `ingress-nginx` namespace:

```bash
# For external-dns-public
kubectl delete deployment external-dns-public -n ingress-nginx
kubectl delete service external-dns-metrics-public -n ingress-nginx
kubectl delete serviceaccount external-dns-public -n ingress-nginx

# For external-dns-private
kubectl delete deployment external-dns-private -n ingress-nginx
kubectl delete service external-dns-metrics-private -n ingress-nginx
kubectl delete serviceaccount external-dns-private -n ingress-nginx
```

2. Apply the new manifests:

```bash
kustomize build <your-project-path> | kubectl apply -f - --server-side
```

3. Verify the new deployment is running:

```bash
kubectl get pods -n external-dns
```

> **Note:** The ClusterRole and ClusterRoleBinding are cluster-scoped resources and will be updated in place. Existing DNS records managed by External-DNS will not be affected as long as the `--txt-owner-id` remains consistent. If you have customized external-dns (as done in SIGHUP Distribution with the `--txt-owner-id` flag), ensure your configuration patches are updated to reference the new `external-dns` namespace.
